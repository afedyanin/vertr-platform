@page "/portfolios/details/{PortfolioId}"

@inject IDialogService DialogService
@inject IToastService ToastService

@inject NavigationManager Navigation

<FluentStack>
    <h3>Portfolio</h3>
</FluentStack>

<br />

<FluentStack Orientation="Orientation.Horizontal">
    <FluentAnchor Href="/portfolios" Appearance="Appearance.Hypertext">Back to portfolios</FluentAnchor>
    <FluentSpacer />
    @if (_simulatedExecutionMode)
    {
        <FluentBadge Appearance="Appearance.Neutral" Fill="highlight" BackgroundColor="#000" Color="#fff">Order execution: Simulated mode</FluentBadge>
    }
    else
    {
        <FluentBadge Fill="somevalue" BackgroundColor="red" Color="white">Order execution: Live trading mode</FluentBadge>
    }
    <FluentSpacer />
    <FluentButton Appearance=Appearance.Accent
                  Title="Open position"
                  @onclick="@HandleOpenPositionAction">Open position</FluentButton>
</FluentStack>

<br />

@if (_portfolio != null)
{
<FluentStack Orientation="Orientation.Horizontal"
                 HorizontalAlignment="HorizontalAlignment.Center"
                 VerticalAlignment="VerticalAlignment.Top">

    <div style="display: table; table-layout: fixed; width: 100%;">
        <div style="overflow-x: auto;">
            @if (_portfolio.IsBacktest)
            {
                    <FluentBadge Appearance="Appearance.Accent" Circular=true style="width: 100%;">Backtest portfolio</FluentBadge>
            }
            else
            {
                    <FluentBadge Appearance="Appearance.Neutral" Circular=true style="width: 100%;">Strategy portfolio</FluentBadge>
            }
            <FluentTextField Value="@_portfolio.Id.ToString()" ReadOnly Appearance="FluentInputAppearance.Filled" style="width: 100%;">Id:</FluentTextField>
            <FluentTextField Value="@_portfolio.UpdatedAt.ToString()" ReadOnly Appearance="FluentInputAppearance.Filled" style="width: 100%;">Updated At:</FluentTextField>
            <FluentTextField Value="@_portfolio.Name" ReadOnly Appearance="FluentInputAppearance.Filled" style="width: 100%;">Name:</FluentTextField>
        </div>
    </div>

    <FluentSpacer />

    <div style="display: table; table-layout: fixed; width: 100%;">
        <div style="overflow-x: auto;">
            <FluentDataGrid @ref=dataGrid
                TGridItem=PositionModel
                Items="@_positions"
                Virtualize=true
                ShowHover=true
                Style="width: 100%;"
                DisplayMode="DataGridDisplayMode.Table"
                RowSize="@DataGridRowSize.Medium">
                    <PropertyColumn Property="@(p => p.Instrument.GetFullName())" Sortable="true"  Title="Instrument" />
                    <PropertyColumn Property="@(p => p.Position.Balance.ToString())" Sortable="true" Title="Balance" />
                    <TemplateColumn Title="">
                            <FluentButton Title="Close" Disabled=@context.TradingDisabled @onclick="@(async () => await @HandleClosePositionAction(context))" >Close</FluentButton>
                    </TemplateColumn>
                    <TemplateColumn Title="">
                            <FluentButton Title="Reverse" Disabled=@context.TradingDisabled @onclick="@(async () => await HandleReversePositionAction(context))">Reverse</FluentButton>
                    </TemplateColumn>
            </FluentDataGrid>
        </div>
    </div>
</FluentStack>

<br />

<TradeOperationsGrid Height="800px"
    @ref=operationsGrid
    TableName="Trade operations"
    PortfolioId="@PortfolioId" />
}
else
{
    <h4>Portfolio is not found</h4>
}


